<h3>{% block title %}新規登録{% endblock title %}</h3>
<h3>{{ indate }}</h3>
<h4>TOTAL：<span id="total"></span>（分）です。</h4>
<span id="test"></span>
<!doctype html>
<head>
    <!-- Required meta tags
<html lang="ja">-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
          integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

    <title>カレンダー</title>
</head>

<body>
<style>
    table {
        table-layout: fixed;
    }

    .table tr td {
    border: 1px solid #eceeef;
    }



</style>
<form action="" method="POST">
    {{ form.management_form }}
    <table class="table">
        <thead>
        <tr>
            <th>大項目</th>
            <th>中項目</th>
            <th>小項目</th>
            <th>時間</th>
            <th>備考</th>
        </tr>
        </thead>

        <tbody id="answers">
        {% for fm in form %}
        {{ fm.id }}
        {{ fm.errors }}
        <tr>
            <td>{{ fm.LargeItem }}</td>
            <td>{{ fm.MiddleItem }}</td>
            <td>{{ fm.SmallItem }}</td>
            <td>{{ fm.kosu }}</td>
            <td>{{ fm.memo }}</td>
        </tr>
        {% endfor %}
        </tbody>

    </table>

    <button id="add" type="button" class="btn btn-primary">行追加</button>
    <button type="submit" class="btn btn-primary">送信</button>
    <a href="{% url 'mycalendar:month_with_schedule' %}" class="btn btn-primary">戻る</a>
    {% csrf_token %}
</form>

<table class="table">
    <thead>
    <tr>
        <th>大項目</th>
        <th>中項目</th>
        <th>小項目</th>
        <th>時間</th>
        <th>備考</th>
    </tr>
    </thead>

    <tbody>
    {% for reg in registered %}
    <tr>
        <td>{{ reg.LargeItem }}</td>
        <td>{{ reg.MiddleItem }}</td>
        <td>{{ reg.SmallItem }}</td>
        <td>{{ reg.kosu }}</td>
        <td>{{ reg.memo }}</td>
    </tr>
    {% endfor %}
    </tbody>

</table>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
        integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
        integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>

<script>
  // 大カテゴリpk: [[カテゴリ1pk, カテゴリ1表示名], [カテゴリ2pk, カテゴリ2表示名]]...のようになります。
  var category = {
    {% for li in LargeItem %}
      {{ li.pk }}: [
          {% for c in li.middleitem_set.all %}
            [ {{ c.pk }}, '{{ c.name }}' ],
          {% endfor %}
          ],
    {% endfor %}
  };

  $(function() {
      // LargeItemで終わるidのもの、つまり大カテゴリ内を選択したら呼ばれる
      $('[id$=LargeItem]').on('change', function(){
          // [カテゴリ1pk, カテゴリ1表示名] を取得する。
          var categories = category[this.value];
          var option_element = '';
          for(c of categories){
              var pk = c[0];  // カテゴリpk
              var text = c[1];  // カテゴリ表示名
              option_element += '<option value=' + pk + ' >' + text + '</option>';
          }
          // 大カテゴリselectの親がtd要素なので、parentとし、次のtdの中にあるselectが中カテゴリとなるselect要素です。
          var small_category_select_element = $(this).parent().next('td').find('select');
          console.log(small_category_select_element);
          small_category_select_element.html(option_element);
      })
  });


$(function(){
  var current_count = parseInt($('input#id_form-TOTAL_FORMS').val());
  $('button#add').on('click', function(){
    var element = `<tr><td><input type="text" name="form-${current_count}-LargeItem" maxlength="50" id="id_form-${current_count}-LargeItem" /></td>
    <td><input type="text" name="form-${current_count}-MiddleItem" maxlength="50" id="id_form-${current_count}-MiddleItem" /></td>
    <td><input type="text" name="form-${current_count}-SmallItem" maxlength="50" id="id_form-${current_count}-SmallItem" /></td>
    <td><input type="number" name="form-${current_count}-kosu" value="0" id="id_form-${current_count}-kosu" /></td>
    <td><input type="text" name="form-${current_count}-memo" maxlength="50" id="id_form-${current_count}-memo" /></td></tr>`;
    $('tbody#answers').append(element);
    current_count += 1;
    $('input#id_form-TOTAL_FORMS').attr('value', current_count);

  $('input[type="number"]').on('keyup change', function() {
    update_field();
  });

  function update_field(){
    var current_count = parseInt($('input#id_form-TOTAL_FORMS').val());
    var result = Number({{ totalkosu.totalkosu }});;
    for(var i = 0; i < current_count; i++){
        result = result + parseInt($('#id_form-'+i+'-kosu').val()) ;
        $('#total').text(result);
        }
    }
  });
});

//入力フィード数を取得し、その数分の和を取得する処理
function update_field(){
    var current_count = parseInt($('input#id_form-TOTAL_FORMS').val());
    var result = Number({{ totalkosu.totalkosu }});
    for(var i = 0; i < current_count; i++){
        result = result + parseInt($('#id_form-'+i+'-kosu').val()) ;
        $('#total').text(result);
    }
}

//入力フィールドから入力が離された時に起動
$(function() {
  $('input[type="number"]').on('keyup change', function() {
    update_field();
  });
});


$(document).ready(function(){
    var result = Number({{ totalkosu.totalkosu }});
    $('#total').text(result);
});


</script>
</body>